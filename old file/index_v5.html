<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
    body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
    .loading-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    button:active { transform: scale(0.95); transition: 0.1s; }
  </style>
</head>
<body>

  <div id="loading-layer" class="loading-screen">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mb-3"></div>
    <p id="loading-text" class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...</p>
  </div>

  <div class="max-w-md mx-auto min-h-screen bg-gray-50 pb-24">
    <div class="bg-gradient-to-br from-yellow-500 to-orange-600 p-6 text-white rounded-b-3xl shadow-lg">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-full bg-white bg-opacity-20 border-2 border-white overflow-hidden shadow-inner">
          <img id="user-img" src="https://via.placeholder.com/150" class="w-full h-full object-cover">
        </div>
        <div>
          <h2 id="display-name" class="text-xl font-bold italic">...</h2>
          <p id="display-role" class="text-xs bg-black bg-opacity-20 inline-block px-2 py-0.5 rounded-full mt-1 uppercase font-bold tracking-wider">GUEST</p>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-6">
        <div class="bg-white bg-opacity-10 p-3 rounded-2xl border border-white border-opacity-10">
          <p class="text-[10px] opacity-80 uppercase font-bold tracking-tighter">BP Balance</p>
          <p id="display-bp" class="text-3xl font-black">0</p>
        </div>
        <div class="bg-white bg-opacity-10 p-3 rounded-2xl border border-white border-opacity-10 text-right">
          <p class="text-[10px] opacity-80 uppercase font-bold tracking-tighter">Acc. CB</p>
          <p id="display-cb" class="text-3xl font-black">0</p>
        </div>
      </div>
    </div>

    <div class="p-4 grid grid-cols-3 gap-2 sticky top-0 z-50 bg-gray-50 bg-opacity-90 backdrop-blur-sm">
      <button onclick="showTab('customer')" id="tab-customer" class="bg-white p-3 rounded-xl shadow-sm font-bold text-xs text-yellow-600 border-b-4 border-yellow-500">‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
      <button onclick="showTab('chef')" id="tab-chef" class="bg-white p-3 rounded-xl shadow-sm font-bold text-xs text-gray-400">‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</button>
      <button onclick="showTab('admin')" id="tab-admin" class="bg-white p-3 rounded-xl shadow-sm font-bold text-xs text-gray-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
    </div>

    <div id="page-customer" class="p-4">
       <div class="bg-white p-6 rounded-3xl shadow-xl space-y-4 border border-gray-100">
          <h3 class="font-bold text-gray-700">üìã ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
          <input id="jobTitle" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô..." class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-yellow-400 border-none text-sm">
          <select id="jobType" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border-none text-sm" onchange="updateEstCB()"></select>
          <div class="bg-yellow-50 p-4 rounded-2xl flex justify-between items-center border border-yellow-100">
            <span class="text-xs font-bold text-yellow-700">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</span>
            <span class="text-xl font-black text-yellow-600"><span id="estCBDisplay">0</span> <small class="text-xs">CB</small></span>
          </div>
          <button onclick="submitOrder()" class="w-full bg-yellow-500 p-4 rounded-2xl text-white font-bold shadow-lg shadow-yellow-200 text-lg">‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß</button>
       </div>
    </div>

    <div id="page-chef" class="p-4 hidden">
       <div id="order-list" class="space-y-4"></div>
    </div>

    <div id="page-admin" class="p-4 hidden">
       <div class="bg-white p-5 rounded-2xl shadow-sm border-t-4 border-yellow-500 mb-4">
         <h3 class="font-bold text-gray-700 mb-3 text-sm">‚öôÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (Config)</h3>
         <div id="config-list" class="space-y-2 text-xs"></div>
       </div>
       <div class="bg-white p-5 rounded-2xl shadow-sm border-t-4 border-green-500">
         <h3 class="font-bold text-gray-700 mb-3 text-sm">üéÅ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Rewards)</h3>
         <div id="reward-list" class="space-y-2 text-xs"></div>
       </div>
    </div>
  </div>

  <script>
    // === CONFIGURATION ===
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxelWNQWMsswiUwtqRqlFAUvlFUejdStFCMSwC2FpysqVJ7j0YfXYMnYpsr-AEGFtnULQ/exec";
    const LIFF_ID = "2008904245-TsV7LL73";
    
    let userProfile = {};

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Iframe/CORS)
    async function callApi(action, params = {}) {
      const query = new URLSearchParams({ action, ...params }).toString();
      try {
        const response = await fetch(`${WEB_APP_URL}?${query}`);
        if (!response.ok) throw new Error('Network response was not ok');
        return await response.json();
      } catch (err) {
        console.error("API Error:", err);
        throw err;
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
    async function initLiff() {
      const loadingText = document.getElementById('loading-text');
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        userProfile = await liff.getProfile();
        document.getElementById('display-name').innerText = userProfile.displayName;
        if (userProfile.pictureUrl) document.getElementById('user-img').src = userProfile.pictureUrl;

        refreshData();
      } catch (e) {
        console.error("LIFF Error:", e);
        loadingText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö...";
        userProfile = { userId: "TEST-USER-001", displayName: "Test User" };
        refreshData();
      }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å
    async function refreshData() {
      try {
        const stats = await callApi('getUserStats', { lineId: userProfile.userId });
        document.getElementById('display-bp').innerText = stats.currentBp || 0;
        document.getElementById('display-cb').innerText = stats.accCb || 0;
        document.getElementById('display-role').innerText = stats.role || "MEMBER";
        
        loadConfig();
        loadOrders();
        document.getElementById('loading-layer').style.display = 'none';
      } catch (e) {
        Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
      }
    }

    // ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô
    async function submitOrder() {
      const title = document.getElementById('jobTitle').value;
      const type = document.getElementById('jobType').value;
      const cb = document.getElementById('estCBDisplay').innerText;
      
      if (!title || !type) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô', 'warning');

      Swal.showLoading();
      try {
        const res = await callApi('submitOrder', {
          lineId: userProfile.userId,
          name: userProfile.displayName,
          title: title,
          type: type,
          cb: cb
        });
        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', res.message, 'success');
        document.getElementById('jobTitle').value = "";
        refreshData();
      } catch (e) {
        Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß
    async function loadOrders() {
      try {
        const orders = await callApi('getOrders');
        const list = document.getElementById('order-list');
        if (!orders || orders.length === 0) {
          list.innerHTML = "<div class='text-center p-10 text-gray-400 italic bg-white rounded-3xl'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>";
          return;
        }
        list.innerHTML = orders.reverse().map(o => `
          <div class="bg-white p-5 rounded-2xl shadow-sm border-l-8 ${o.status === 'Done' ? 'border-green-400' : 'border-yellow-400'}">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded uppercase font-bold tracking-widest">${o.status}</span>
                <h4 class="font-bold text-gray-800 mt-1">${o.title}</h4>
                <p class="text-[10px] text-gray-400">${o.customer} ‚Ä¢ ${o.type}</p>
              </div>
              <div class="text-right ml-2">
                <span class="text-xl font-black text-gray-700">${o.cb}</span>
                <p class="text-[8px] text-gray-400 font-bold uppercase italic">CB Unit</p>
              </div>
            </div>
            ${(o.status !== 'Done' && document.getElementById('display-role').innerText.includes('CHEF')) ? `
              <div class="mt-4 flex justify-end">
                <button onclick="finishOrderModal('${o.id}', '${o.cb}')" class="bg-green-500 text-white text-[10px] px-4 py-2 rounded-lg font-bold">‡∏à‡∏ö‡∏á‡∏≤‡∏ô & ‡πÉ‡∏´‡πâ BP</button>
              </div>
            ` : ''}
          </div>
        `).join('');
      } catch (e) { console.error(e); }
    }

    // ‡∏à‡∏ö‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏ü)
    async function finishOrderModal(id, cb) {
      const { value: bp } = await Swal.fire({
        title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ï‡πâ‡∏° BP',
        input: 'number',
        inputLabel: `‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å ${cb} CB ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà BP?`,
        inputValue: cb * 2,
        showCancelButton: true
      });

      if (bp) {
        Swal.showLoading();
        await callApi('finishOrder', { id: id, bp: bp });
        Swal.fire('‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏°‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${bp} BP ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        refreshData();
      }
    }

    // ‡∏£‡∏∞‡∏ö‡∏ö Tab
    function showTab(tab) {
      ['customer', 'chef', 'admin'].forEach(t => {
        document.getElementById('page-' + t).classList.add('hidden');
        document.getElementById('tab-' + t).className = "bg-white p-3 rounded-xl shadow-sm font-bold text-xs text-gray-400";
      });
      document.getElementById('page-' + tab).classList.remove('hidden');
      document.getElementById('tab-' + tab).className = "bg-white p-3 rounded-xl shadow-sm font-bold text-xs text-yellow-600 border-b-4 border-yellow-500";
      if(tab === 'chef') loadOrders();
      if(tab === 'admin') loadAdminData();
    }

    async function loadConfig() {
      const data = await callApi('getConfig');
      document.getElementById('jobType').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...</option>' + 
        data.map(i => `<option value="${i.category}" data-cb="${i.cb}">${i.category}</option>`).join('');
    }

    async function loadAdminData() {
      const configs = await callApi('getConfig');
      const rewards = await callApi('getRewards');
      document.getElementById('config-list').innerHTML = configs.map(c => `<div class="flex justify-between border-b pb-1"><span>${c.category}</span><span class="font-bold">${c.cb} CB</span></div>`).join('');
      document.getElementById('reward-list').innerHTML = rewards.map(r => `<div class="flex justify-between border-b pb-1"><span>${r.name}</span><span class="font-bold">${r.points} BP</span></div>`).join('');
    }

    function updateEstCB() {
      const select = document.getElementById('jobType');
      document.getElementById('estCBDisplay').innerText = select.options[select.selectedIndex]?.dataset.cb || 0;
    }

    window.onload = initLiff;
  </script>
</body>
</html>