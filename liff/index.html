<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สั่งอาหาร - LINE OA</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <h1>สั่งอาหาร</h1>
    <div id="menu">
        <!-- Menu items will be loaded here -->
    </div>
    <button id="placeOrder">สั่งอาหาร</button>

    <script>
        async function initializeLiff() {
            await liff.init({ liffId: '2008904245-nAKim9ql' }); // Replace with actual LIFF ID
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }

        async function loadMenu() {
            // Fetch menu from GAS
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbxmlxCCpPQIym8txERqSDDZrHSkAdT0MsuZHMLgV_UUh2L7J9QkpACcYhxNXoZ38-Rp/exec?action=getMenu');
                const menu = await response.json();
                const menuDiv = document.getElementById('menu');
                menu.forEach(item => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label>
                            <input type="checkbox" data-name="${item.name}" data-cb="${item.cb}"> ${item.name} (${item.cb} CB)
                        </label>
                        <input type="number" min="1" value="1" data-quantity>
                    `;
                    menuDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading menu:', error);
                alert('Failed to load menu');
            }
        }

        document.getElementById('placeOrder').addEventListener('click', async () => {
            const profile = await liff.getProfile();
            const items = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const quantityInput = cb.closest('div').querySelector('input[data-quantity]');
                if (quantityInput) {
                    const quantity = parseInt(quantityInput.value);
                    items.push({ name: cb.dataset.name, quantity: quantity });
                }
            });
            const data = {
                action: 'placeOrder',
                lineId: profile.userId,
                items: items
            };
            // Post to GAS Web App URL
            const url = 'https://script.google.com/macros/s/AKfycbxmlxCCpPQIym8txERqSDDZrHSkAdT0MsuZHMLgV_UUh2L7J9QkpACcYhxNXoZ38-Rp/exec';
            const params = new URLSearchParams({
                action: 'placeOrder',
                lineId: profile.userId,
                items: JSON.stringify(items)
            });
            const response = await fetch(`${url}?${params}`, {
                method: 'GET'
            });
            if (response.ok) {
                const text = await response.text();
                alert(text === 'Order placed' ? 'Order placed successfully!' : 'Failed to place order: ' + text);
            } else {
                alert('Failed to place order: ' + response.statusText);
            }
        });

        initializeLiff();
        loadMenu();
    </script>
</body>
</html>