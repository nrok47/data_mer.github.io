<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chayagorn Kitchen | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ß</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .order-card { transition: all 0.3s ease; }
    .order-card:hover { transform: translateY(-2px); shadow: 0 4px 12px rgba(0,0,0,0.05); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="mt-4 text-slate-500 italic">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏£‡∏±‡∏ß...</p>
    </div>
  </div>

  <div id="login-page" class="hidden flex flex-col items-center justify-center min-h-screen p-6">
    <div class="text-6xl mb-6">üë®‚Äçüç≥</div>
    <h1 class="text-3xl font-bold text-slate-800 mb-2 text-center">Chayagorn Kitchen</h1>
    <p class="text-slate-500 mb-8 text-center text-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° BP</p>
    <button onclick="liff.login()" class="w-full max-w-xs bg-[#06C755] text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-[#05b34c] transition-all scale-100 active:scale-95">
      LOG IN WITH LINE
    </button>
  </div>

  <div id="app" class="hidden pb-10">
    
    <div class="bg-blue-600 text-white p-6 pb-20 rounded-b-[2.5rem] shadow-xl">
      <div class="flex justify-between items-center max-w-md mx-auto">
        <div class="flex items-center space-x-3">
          <img id="user-img" class="h-14 w-14 rounded-full border-2 border-white/40 shadow-inner">
          <div>
            <p class="text-blue-100 text-xs opacity-80">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</p>
            <h2 id="user-name" class="text-lg font-semibold leading-tight">-</h2>
            <span id="role-badge" class="inline-block bg-white/20 text-[10px] px-2 py-0.5 rounded-md mt-1 italic">Guest</span>
          </div>
        </div>
        <div class="text-right">
          <button onclick="liff.logout(); location.reload();" class="text-white/60 text-xs border border-white/20 px-2 py-1 rounded">Logout</button>
        </div>
      </div>
    </div>

    <div class="max-w-md mx-auto -mt-12 px-4 space-y-5">
      
      <div class="grid grid-cols-2 gap-3">
        <div class="glass p-4 rounded-3xl shadow-sm text-center border border-white">
          <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mb-1">‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏û (CB)</p>
          <p id="stat-cb" class="text-2xl font-bold text-blue-600">0</p>
        </div>
        <div class="glass p-4 rounded-3xl shadow-sm text-center border border-white border-b-4 border-b-green-400">
          <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mb-1">‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏¥‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢ (BP)</p>
          <p id="stat-bp" class="text-2xl font-bold text-green-600">0</p>
        </div>
      </div>

      <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
          <span class="mr-2">üìù</span> ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        </h3>
        <form id="order-form" class="space-y-4">
          <input type="text" id="title" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô..." class="w-full bg-slate-50 border-none rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm" required>
          <textarea id="detail" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." class="w-full bg-slate-50 border-none rounded-xl p-3.5 focus:ring-2 focus:ring-blue-500 outline-none text-sm"></textarea>
          
          <div class="grid grid-cols-2 gap-3">
            <select id="type" class="bg-slate-50 border-none rounded-xl p-3.5 outline-none text-sm font-medium text-slate-600">
              <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ø">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ø</option>
              <option value="‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ">‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
              <option value="‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà">‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>
              <option value="‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á">‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</option>
            </select>
            <select id="priority" class="bg-slate-50 border-none rounded-xl p-3.5 outline-none text-sm font-medium text-slate-600">
              <option value="A">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ö (A)</option>
              <option value="B" selected>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏π‡∏Å‡∏≠‡πä‡∏≠‡∏î (B)</option>
              <option value="C">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏´‡∏≠‡∏¢‡∏ó‡∏≤‡∏Å (C)</option>
            </select>
          </div>

          <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-[0.98] transition-all">
            ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏ü
          </button>
        </form>
      </div>

      <div>
        <div class="flex justify-between items-center mb-4 px-1">
          <h3 class="font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</h3>
          <button onclick="fetchData()" class="text-blue-600 text-xs font-semibold hover:underline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div id="data-list" class="space-y-3">
          </div>
      </div>

    </div>
  </div>

  <script>
    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏¢‡∏Å‡∏£‡πÉ‡∏´‡πâ‡∏à‡∏≥‡πÑ‡∏ß‡πâ) ---
    const LIFF_ID = '2008904245-TsV7LL73';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxelWNQWMsswiUwtqRqlFAUvlFUejdStFCMSwC2FpysqVJ7j0YfXYMnYpsr-AEGFtnULQ/exec';

    let userRole = 'User'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
          runApp();
        } else {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('login-page').style.display = 'flex';
        }
      } catch (err) {
        console.error("LIFF Init Error:", err);
        alert("LIFF Error: " + err.message);
      }
    }

    // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Login ‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
    async function runApp() {
      const profile = await liff.getProfile();
      document.getElementById('user-name').innerText = profile.displayName;
      document.getElementById('user-img').src = profile.pictureUrl;

      // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Role, CB, BP)
      try {
        const res = await fetch(`${GAS_URL}?action=getStats&lineId=${profile.userId}`);
        const stats = await res.json();
        
        userRole = stats.role || 'User';
        document.getElementById('role-badge').innerText = userRole;
        document.getElementById('stat-cb').innerText = (stats.accCb || 0) + " CB";
        document.getElementById('stat-bp').innerText = (stats.currentBp || 0) + " BP";
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Chef ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Badge
        if(userRole === 'Chef') {
           document.getElementById('role-badge').classList.add('bg-orange-500/30', 'text-orange-200');
        }
      } catch (e) {
        console.log("Stats error:", e);
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      fetchData();
    }

    // 3. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function fetchData() {
      try {
        const res = await fetch(GAS_URL);
        const data = await res.json();
        renderOrders(data.slice(1)); // ‡∏ï‡∏±‡∏î Header ‡∏≠‡∏≠‡∏Å
      } catch (err) {
        console.error("Fetch Data Error:", err);
      }
    }

    // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
    function renderOrders(rows) {
      const listContainer = document.getElementById('data-list');
      if (rows.length === 0) {
        listContainer.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</div>';
        return;
      }

      listContainer.innerHTML = rows.reverse().map(row => {
        const isDone = row[8] === 'Done';
        const priorityLabel = row[9] || 'B';
        
        // ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏ü (CRUD)
        const chefTools = (userRole === 'Chef' && !isDone) ? `
          <div class="mt-4 pt-3 border-t border-slate-50 flex gap-2">
            <button onclick="finishOrder('${row[0]}')" class="flex-1 bg-green-500 text-white text-[11px] py-2 rounded-lg font-bold shadow-sm shadow-green-100">‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡πÉ‡∏´‡πâ BP</button>
            <button onclick="deleteOrder('${row[0]}')" class="bg-slate-100 text-slate-400 text-[11px] px-3 py-2 rounded-lg font-bold">‡∏•‡∏ö</button>
          </div>
        ` : '';

        return `
          <div class="order-card bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden">
            <div class="flex justify-between items-start mb-2">
              <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${isDone ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}">
                ${isDone ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
              </span>
              <span class="text-[10px] font-bold text-blue-400 bg-blue-50 px-2 py-0.5 rounded-full">Prio: ${priorityLabel}</span>
            </div>
            <h4 class="font-bold text-slate-800 text-base leading-tight">${row[4]}</h4>
            <p class="text-slate-500 text-xs mt-1 leading-relaxed">${row[5] || '-'}</p>
            <div class="flex justify-between items-center mt-3 text-[10px] text-slate-300">
              <span>‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á: ${row[3]}</span>
              <span>ID: ${row[0].substring(row[0].length - 5)}</span>
            </div>
            ${chefTools}
          </div>
        `;
      }).join('');
    }

    // 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô (Submit Order)
    document.getElementById('order-form').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('btn-submit');
      btn.disabled = true;
      btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

      const profile = await liff.getProfile();
      const payload = {
        action: 'submitOrder',
        lineId: profile.userId,
        name: profile.displayName,
        title: document.getElementById('title').value,
        detail: document.getElementById('detail').value,
        type: document.getElementById('type').value,
        priority: document.getElementById('priority').value
      };

      try {
        await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        alert("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        document.getElementById('order-form').reset();
        fetchData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏ü';
      }
    };

    // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡∏ü (Finish Order)
    async function finishOrder(orderId) {
      const bp = prompt("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ä‡∏ü! ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πâ‡∏° BP ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏î‡∏µ? (0-10)", "5");
      if (bp === null || bp === "") return;

      const btn = event.target;
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
      
      try {
        await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'finishOrder', id: orderId, bp: bp })
        });
        alert("‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        location.reload(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    // 7. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏á‡∏≤‡∏ô
    async function deleteOrder(orderId) {
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß?")) return;
      try {
        await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'deleteOrder', id: orderId })
        });
        fetchData();
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    // ‡∏£‡∏±‡∏ô LIFF
    initLiff();
  </script>
</body>
</html>