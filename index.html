<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chayagorn Kitchen | Admin Dashboard</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .active-tab { border-bottom: 4px solid #f59e0b; color: #f59e0b; font-weight: bold; }
    .stat-card { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .chart-bar { transition: width 1s ease-in-out; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div id="app" class="max-w-2xl mx-auto pb-24">
    <header class="bg-gradient-to-r from-yellow-500 to-orange-600 p-6 text-white text-center shadow-lg rounded-b-3xl mb-4">
      <h1 class="text-3xl font-bold uppercase">Chayagorn Kitchen</h1>
      <p class="text-sm opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ Bandwidth & ‡∏à‡∏¥‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢</p>
    </header>

    <nav class="bg-white shadow-md sticky top-0 z-10 flex justify-around p-2 mb-4 rounded-xl mx-4">
      <button onclick="showTab('customer')" id="tab-customer" class="flex-1 py-2 active-tab">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button onclick="showTab('chef')" id="tab-chef" class="flex-1 py-2">‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡∏ü</button>
      <button onclick="showTab('admin')" id="tab-admin" class="flex-1 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
    </nav>

    <div id="page-customer" class="p-4 space-y-6">
      <div class="stat-card p-5 rounded-2xl shadow-lg text-white">
        <div class="flex items-center gap-3 mb-4">
          <img id="user-pic" class="w-12 h-12 rounded-full border-2 border-white/20">
          <div>
            <h3 class="text-xl font-bold" id="display-name">Loading...</h3>
            <span id="display-role" class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full">ROLE</span>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-black/10 p-3 rounded-xl"><p class="text-[10px]">BP ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><h4 class="text-2xl font-black" id="display-bp">0</h4></div>
          <div class="bg-black/10 p-3 rounded-xl"><p class="text-[10px]">ACC. CB</p><h4 class="text-2xl font-black" id="display-cb">0</h4></div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
        <h2 class="text-xl font-bold mb-4">üìã ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏á‡∏≤‡∏ô</h2>
        <div class="space-y-3">
          <input id="jobTitle" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" class="w-full p-4 bg-gray-50 rounded-xl outline-none">
          <textarea id="jobDetail" placeholder="‡∏ö‡∏£‡∏µ‡∏ü‡∏á‡∏≤‡∏ô..." class="w-full p-4 bg-gray-50 rounded-xl h-20"></textarea>
          <select id="jobType" class="w-full p-4 bg-gray-50 rounded-xl" onchange="updateEstCB()"></select>
          <div class="bg-yellow-50 p-4 rounded-xl flex justify-between">
            <span>Estimated:</span><span class="font-bold"><span id="estCBDisplay">0</span> CB</span>
          </div>
          <button onclick="submitOrder()" class="w-full bg-yellow-500 text-white p-4 rounded-xl font-bold">‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
        </div>
      </div>
    </div>

    <div id="page-chef" class="p-4 hidden">
      <div id="order-list" class="space-y-4"></div>
    </div>

    <div id="page-admin" class="p-4 hidden space-y-6">
        <div id="dashboard-section" class="bg-white p-6 rounded-3xl shadow-md border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Head Chef Dashboard</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-blue-50 rounded-2xl">
                    <p class="text-[10px] text-blue-400 uppercase font-bold">Job ‡∏ï‡πà‡∏≠ 100 CB</p>
                    <h4 id="ratio-job-cb" class="text-2xl font-black text-blue-600">0</h4>
                </div>
                <div class="p-4 bg-green-50 rounded-2xl">
                    <p class="text-[10px] text-green-400 uppercase font-bold">Total Finished CB</p>
                    <h4 id="total-finished-cb" class="text-2xl font-black text-green-600">0</h4>
                </div>
            </div>
            
            <h4 class="font-bold text-sm text-gray-500 mb-2 uppercase">User Experience Ranking (CB)</h4>
            <div id="user-experience-list" class="space-y-3">
                </div>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-yellow-500">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold">‚öôÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (Config)</h3>
            <button onclick="addConfig()" class="bg-yellow-500 text-white px-4 py-1 rounded-full text-xs font-bold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
          </div>
          <div id="config-list" class="space-y-2"></div>
        </div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008904245-TsV7LL73';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxelWNQWMsswiUwtqRqlFAUvlFUejdStFCMSwC2FpysqVJ7j0YfXYMnYpsr-AEGFtnULQ/exec';
    let currentUser = {};

    async function init() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      currentUser = profile;
      document.getElementById('user-pic').src = profile.pictureUrl;
      await loadUserStats();
      loadConfig();
      fetchOrders();
    }

    async function loadUserStats() {
      const res = await fetch(`${GAS_URL}?action=getStats&lineId=${currentUser.userId}&name=${encodeURIComponent(currentUser.displayName)}&pictureUrl=${encodeURIComponent(currentUser.pictureUrl)}`);
      const s = await res.json();
      document.getElementById('display-name').innerText = s.name;
      document.getElementById('display-bp').innerText = s.currentBp;
      document.getElementById('display-cb').innerText = s.accCb;
      document.getElementById('display-role').innerText = s.role;
      currentUser.role = s.role;
      if (s.role === 'Head Chef') loadDashboard();
    }

    async function loadDashboard() {
        const res = await fetch(`${GAS_URL}?action=getDashboard`);
        const data = await res.json();
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Ratio Job ‡∏ï‡πà‡∏≠ CB (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠ 100 CB)
        const ratio = data.totalCb > 0 ? ((data.doneJobs / data.totalCb) * 100).toFixed(2) : 0;
        document.getElementById('ratio-job-cb').innerText = ratio;
        document.getElementById('total-finished-cb').innerText = data.totalCb;

        // Render User Ranking (Experience)
        const sortedUsers = data.userExp.sort((a, b) => b.cb - a.cb);
        const maxCb = sortedUsers[0]?.cb || 1;
        document.getElementById('user-experience-list').innerHTML = sortedUsers.map(u => `
            <div>
                <div class="flex justify-between text-[11px] mb-1">
                    <span class="font-bold text-gray-700">${u.name} (${u.role})</span>
                    <span class="text-gray-400">${u.cb} CB / ${u.bp} BP</span>
                </div>
                <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                    <div class="chart-bar bg-orange-400 h-full" style="width: ${(u.cb / maxCb * 100)}%"></div>
                </div>
            </div>
        `).join('');
    }

    async function fetchOrders() {
      const res = await fetch(GAS_URL);
      const data = await res.json();
      renderOrders(data.slice(1));
    }

    function renderOrders(rows) {
      const list = document.getElementById('order-list');
      list.innerHTML = rows.reverse().map(o => `
        <div class="bg-white p-5 rounded-2xl shadow-md border-l-8 ${o[8]==='Done'?'border-green-500':'border-yellow-500'} mb-4">
          <div class="flex justify-between">
            <div><h4 class="font-bold text-lg">${o[4]}</h4><p class="text-xs text-gray-500">${o[3]} ‚Ä¢ ${o[6]}</p></div>
            <div class="text-right"><span class="block font-black text-xl">${o[7]}</span><span class="text-[8px] text-gray-400 italic">CB</span></div>
          </div>
          ${(currentUser.role === 'Chef' || currentUser.role === 'Head Chef') && o[8] !== 'Done' ? `
            <button onclick="finishOrderModal('${o[0]}', ${o[7]})" class="w-full mt-4 bg-green-500 text-white py-2 rounded-lg font-bold">‡∏à‡∏ö‡∏á‡∏≤‡∏ô & ‡∏õ‡∏£‡∏±‡∏ö CB/BP</button>
          ` : ''}
        </div>
      `).join('');
    }

    async function finishOrderModal(id, cb) {
      const { value: formValues } = await Swal.fire({
        title: '‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•',
        html: `
          <input id="swal-cb" type="number" class="swal2-input" value="${cb}" placeholder="Adjusted CB">
          <input id="swal-bp" type="number" class="swal2-input" value="${cb * 2}" placeholder="BP Point">
        `,
        preConfirm: () => ({ cb: document.getElementById('swal-cb').value, bp: document.getElementById('swal-bp').value })
      });
      if (formValues) {
        await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'finishOrder', id, ...formValues }) });
        location.reload();
      }
    }

    async function loadConfig() {
      const res = await fetch(`${GAS_URL}?action=getConfig`);
      const data = await res.json();
      const rows = data.slice(1);
      document.getElementById('jobType').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...</option>' + rows.map(r => `<option value="${r[1]}" data-cb="${r[2]}">${r[1]}</option>`).join('');
      document.getElementById('config-list').innerHTML = rows.map(r => `<div class="flex justify-between bg-gray-50 p-2 rounded-lg"><span>${r[1]} (${r[2]} CB)</span><button onclick="deleteItem('Config','${r[0]}')" class="text-red-400">‡∏•‡∏ö</button></div>`).join('');
    }

    async function submitOrder() {
      const payload = {
        action: 'submitOrder',
        lineId: currentUser.userId,
        name: currentUser.displayName,
        title: document.getElementById('jobTitle').value,
        detail: document.getElementById('jobDetail').value,
        type: document.getElementById('jobType').value,
        baseCb: parseInt(document.getElementById('estCBDisplay').innerText)
      };
      await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö', 'success');
      fetchOrders();
    }

    function showTab(t) {
      ['customer', 'chef', 'admin'].forEach(tab => document.getElementById('page-'+tab).classList.add('hidden'));
      ['customer', 'chef', 'admin'].forEach(tab => document.getElementById('tab-'+tab).classList.remove('active-tab'));
      document.getElementById('page-'+t).classList.remove('hidden');
      document.getElementById('tab-'+t).classList.add('active-tab');
    }

    function updateEstCB() {
      const sel = document.getElementById('jobType');
      document.getElementById('estCBDisplay').innerText = sel.options[sel.selectedIndex]?.dataset.cb || 0;
    }

    init();
  </script>
</body>
</html>