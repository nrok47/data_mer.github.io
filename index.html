<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chayagorn Kitchen | Full Version</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .active-tab { border-bottom: 4px solid #f59e0b; color: #f59e0b; font-weight: bold; }
    .stat-card { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div id="app" class="max-w-2xl mx-auto pb-24">
    <header class="bg-gradient-to-r from-yellow-500 to-orange-600 p-6 text-white text-center shadow-lg rounded-b-3xl mb-4">
      <h1 class="text-3xl font-bold uppercase">Chayagorn Kitchen</h1>
      <p class="text-sm opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ Bandwidth & ‡∏à‡∏¥‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢ (Full Mode)</p>
    </header>

    <nav class="bg-white shadow-md sticky top-0 z-10 flex justify-around p-2 mb-4 rounded-xl mx-4">
      <button onclick="showTab('customer')" id="tab-customer" class="flex-1 py-2 active-tab">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button onclick="showTab('chef')" id="tab-chef" class="flex-1 py-2">‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡∏ü</button>
      <button onclick="showTab('admin')" id="tab-admin" class="flex-1 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
    </nav>

    <div id="page-customer" class="p-4 space-y-6">
      <div class="stat-card p-5 rounded-2xl shadow-lg text-white">
        <div class="flex justify-between items-start mb-4">
          <div class="flex items-center gap-3">
            <img id="user-pic" class="w-12 h-12 rounded-full border-2 border-white/20">
            <div>
              <h3 class="text-xl font-bold" id="display-name">Loading...</h3>
              <span id="display-role" class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full">ROLE</span>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-black/10 p-3 rounded-xl text-center">
            <p class="text-[10px] opacity-70">BP ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
            <h4 class="text-2xl font-black" id="display-bp">0</h4>
          </div>
          <div class="bg-black/10 p-3 rounded-xl text-center">
            <p class="text-[10px] opacity-70">ACC. CB (‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô)</p>
            <h4 class="text-2xl font-black" id="display-cb">0</h4>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">üìã ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
        <div class="space-y-4">
          <input id="jobTitle" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô" class="w-full p-4 bg-gray-50 rounded-xl outline-none focus:ring-2 focus:ring-yellow-400">
          <textarea id="jobDetail" placeholder="‡∏ö‡∏£‡∏µ‡∏ü‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ..." class="w-full p-4 bg-gray-50 rounded-xl h-24 outline-none"></textarea>
          <select id="jobType" class="w-full p-4 bg-gray-50 rounded-xl outline-none" onchange="updateEstCB()"></select>
          <div class="bg-yellow-50 p-4 rounded-xl flex justify-between items-center border border-yellow-100 text-yellow-800">
             <span>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Estimated):</span>
             <span class="text-2xl font-black"><span id="estCBDisplay">0</span> <small class="text-xs">CB</small></span>
          </div>
          <button onclick="submitOrder()" class="w-full bg-yellow-500 text-white p-4 rounded-xl font-bold text-lg shadow-lg">‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß</button>
        </div>
      </div>
    </div>

    <div id="page-chef" class="p-4 hidden">
      <div id="order-list" class="space-y-4 text-center text-gray-400 italic py-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <div id="page-admin" class="p-4 hidden space-y-6">
      <div class="bg-white p-5 rounded-2xl shadow-md border-t-4 border-yellow-500">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold">‚öôÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (CB Config)</h3>
          <button onclick="addConfig()" class="bg-yellow-500 text-white px-4 py-1 rounded-full text-xs font-bold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
        <div id="config-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID = '2008904245-TsV7LL73';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxelWNQWMsswiUwtqRqlFAUvlFUejdStFCMSwC2FpysqVJ7j0YfXYMnYpsr-AEGFtnULQ/exec';
    
    let currentUser = {};

    async function init() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      currentUser = profile;
      document.getElementById('user-pic').src = profile.pictureUrl;
      loadUserStats();
      loadConfig();
      fetchOrders();
    }

    async function loadUserStats() {
      const res = await fetch(`${GAS_URL}?action=getStats&lineId=${currentUser.userId}&name=${encodeURIComponent(currentUser.displayName)}&pictureUrl=${encodeURIComponent(currentUser.pictureUrl)}`);
      const s = await res.json();
      document.getElementById('display-name').innerText = s.name;
      document.getElementById('display-bp').innerText = s.currentBp;
      document.getElementById('display-cb').innerText = s.accCb;
      document.getElementById('display-role').innerText = s.role;
      currentUser.role = s.role;
    }

    async function fetchOrders() {
      const res = await fetch(GAS_URL);
      const data = await res.json();
      renderOrders(data.slice(1));
    }

    function renderOrders(rows) {
      const list = document.getElementById('order-list');
      if (rows.length === 0) { list.innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß"; return; }
      list.innerHTML = rows.reverse().map(o => `
        <div class="bg-white p-5 rounded-2xl shadow-md border-l-8 ${o[8]==='Done'?'border-green-500':'border-yellow-500'} text-left mb-4">
          <div class="flex justify-between items-start">
            <div>
              <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-gray-100">${o[8]}</span>
              <h4 class="font-bold text-gray-800 text-lg">${o[4]}</h4>
              <p class="text-xs text-gray-500">${o[3]} ‚Ä¢ ${o[6]}</p>
            </div>
            <div class="bg-gray-50 p-2 rounded-lg text-center min-w-[50px]">
              <span class="block font-black text-xl">${o[7]}</span>
              <span class="text-[8px] text-gray-400">CB</span>
            </div>
          </div>
          ${currentUser.role === 'Chef' && o[8] !== 'Done' ? `
            <div class="mt-4 flex gap-2">
              <button onclick="finishOrderModal('${o[0]}', ${o[7]})" class="flex-1 bg-green-500 text-white text-xs py-2 rounded-lg font-bold shadow-md">‡∏à‡∏ö‡∏á‡∏≤‡∏ô & ‡πÉ‡∏´‡πâ BP</button>
              <button onclick="deleteItem('Orders', '${o[0]}')" class="bg-red-50 text-red-400 text-xs px-4 py-2 rounded-lg">‡∏•‡∏ö</button>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    async function submitOrder() {
      const payload = {
        action: 'submitOrder',
        lineId: currentUser.userId,
        name: currentUser.displayName,
        title: document.getElementById('jobTitle').value,
        detail: document.getElementById('jobDetail').value,
        type: document.getElementById('jobType').value,
        baseCb: parseInt(document.getElementById('estCBDisplay').innerText)
      };
      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
      await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏ü', 'success');
      fetchOrders();
    }

    async function finishOrderModal(id, cb) {
      const { value: bp } = await Swal.fire({
        title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ï‡πâ‡∏° BP',
        input: 'number',
        inputValue: cb * 2,
        inputLabel: '‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏¥‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'
      });
      if (!bp) return;
      await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'finishOrder', id, bp }) });
      Swal.fire('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
      location.reload();
    }

    async function loadConfig() {
      const res = await fetch(`${GAS_URL}?action=getConfig`);
      const data = await res.json();
      const rows = data.slice(1);
      document.getElementById('jobType').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô...</option>' + rows.map(r => `<option value="${r[1]}" data-cb="${r[2]}">${r[1]}</option>`).join('');
      document.getElementById('config-list').innerHTML = rows.map(r => `<div class="flex justify-between bg-gray-50 p-3 rounded-xl"><span>${r[1]} (${r[2]} CB)</span><button onclick="deleteItem('Config','${r[0]}')" class="text-red-400">‡∏•‡∏ö</button></div>`).join('');
    }

    async function deleteItem(tab, id) {
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) return;
      await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteOrder', tab, id }) });
      location.reload();
    }

    async function addConfig() {
      const { value: formValues } = await Swal.fire({
        title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô',
        html: '<input id="c-cat" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠"><input id="c-cb" type="number" class="swal2-input" placeholder="CB">',
        preConfirm: () => [document.getElementById('c-cat').value, document.getElementById('c-cb').value]
      });
      if (formValues) {
        await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'saveConfig', category: formValues[0], cb: formValues[1] }) });
        loadConfig();
      }
    }

    function showTab(t) {
      ['customer', 'chef', 'admin'].forEach(tab => document.getElementById('page-'+tab).classList.add('hidden'));
      ['customer', 'chef', 'admin'].forEach(tab => document.getElementById('tab-'+tab).classList.remove('active-tab'));
      document.getElementById('page-'+t).classList.remove('hidden');
      document.getElementById('tab-'+t).classList.add('active-tab');
    }

    function updateEstCB() {
      const sel = document.getElementById('jobType');
      document.getElementById('estCBDisplay').innerText = sel.options[sel.selectedIndex]?.dataset.cb || 0;
    }

    init();
  </script>
</body>
</html>