# คำแนะนำ Copilot สำหรับโปรเจกต์ Chayagorn Kitchen

เอกสารนี้สรุปความรู้ที่จำเป็นสำหรับ AI coding agents เพื่อให้สามารถทำงานได้อย่างมีประสิทธิภาพใน codebase ของ Chayagorn Kitchen ทันที

## 1. ภาพรวมโปรเจกต์

*   **ส่วนหน้า (Frontend):** `index.html` เป็น Single Page Application (SPA) ที่โฮสต์บน GitHub Pages โดยใช้ LINE LIFF SDK สำหรับการยืนยันตัวตนผู้ใช้และการโต้ตอบกับ UI, Tailwind CSS สำหรับการจัดสไตล์, และ SweetAlert2 สำหรับการแจ้งเตือน
*   **ส่วนหลัง (Backend):** Google Apps Script (`Code.gs`) ที่ถูก Deploy เป็นเว็บแอป สคริปต์นี้จัดการตรรกะฝั่งเซิร์ฟเวอร์ทั้งหมด รวมถึงการเรียกใช้ข้อมูลและการจัดการข้อมูล
*   **การจัดเก็บข้อมูล:** Google Sheets ซึ่งระบุด้วย `SPREADSHEET_ID` ใน `Code.gs` ทำหน้าที่เป็นฐานข้อมูลหลักสำหรับคำสั่งซื้อ, โปรไฟล์สมาชิก และการกำหนดค่า

## 2. สถาปัตยกรรมและการไหลของข้อมูล

1.  **การยืนยันตัวตนผู้ใช้:** ผู้ใช้เข้าถึง `index.html` ผ่าน LINE โดย LIFF SDK จัดการการเข้าสู่ระบบ LINE และให้ข้อมูล `lineId`, `displayName` และ `pictureUrl`
2.  **การสื่อสารระหว่างส่วนหน้า-ส่วนหลัง:**
    *   ส่วนหน้า (`index.html`) สื่อสารกับส่วนหลัง Google Apps Script (`Code.gs`) ผ่านคำขอ `GET` และ `POST` ไปยัง `GAS_URL`
    *   คำขอ `GET` (จัดการโดย `doGet` ใน `Code.gs`) ส่วนใหญ่ใช้สำหรับการดึงข้อมูล (สถิติผู้ใช้, คำสั่งซื้อ, แดชบอร์ด, การกำหนดค่า)
    *   คำขอ `POST` (จัดการโดย `doPost` ใน `Code.gs`) ใช้สำหรับการส่งข้อมูลหรือการกระตุ้นการกระทำ (ส่งคำสั่งซื้อ, อัปเดตสถานะคำสั่งซื้อ, จัดการการกำหนดค่า)
    *   ข้อมูลทั้งหมดแลกเปลี่ยนในรูปแบบ JSON
3.  **การเก็บรักษาข้อมูล:** `Code.gs` โต้ตอบโดยตรงกับ Google Sheet เพื่ออ่านและเขียนไปยังแท็บเฉพาะ (`Orders`, `Members`, `Config`)

## 3. ข้อควรพิจารณาด้านความปลอดภัยที่สำคัญ

จุดเน้นหลักด้านความปลอดภัยสำหรับโปรเจกต์นี้คือการโต้ตอบระหว่าง `index.html` ฝั่งไคลเอ็นต์และ Google Apps Script `Code.gs`

### 3.1 การอนุญาตบนเซิร์ฟเวอร์ (CRITICAL)

*   **ปัญหา:** `Code.gs:doPost` ปัจจุบันอนุญาตให้ผู้ใช้ LIFF ที่ยืนยันตัวตนแล้วสามารถดำเนินการที่ละเอียดอ่อนได้ เช่น `updateOrder`, `finishOrder`, `deleteOrder` และ `saveConfig` โดยไม่ต้องตรวจสอบบทบาทหรือความเป็นเจ้าของ
*   **คำแนะนำ:** ก่อนที่จะนำไปใช้หรือแก้ไขการกระทำ `doPost` ใดๆ **ต้อง** เพิ่มการตรวจสอบการอนุญาตฝั่งเซิร์ฟเวอร์ภายใน `Code.gs` เสมอ
    *   ดึง `role` ของผู้ใช้จากชีต 'Members' โดยใช้ `lineId` ของพวกเขา
    *   จำกัดการกระทำตามบทบาทนี้ (เช่น เฉพาะ 'Head Chef' เท่านั้นที่สามารถจัดการการกำหนดค่า, อัปเดตสถานะคำสั่งซื้อ หรือเสร็จสิ้นคำสั่งซื้อได้)
    *   สำหรับการกระทำเฉพาะผู้ใช้ (เช่น ผู้ใช้ยกเลิกคำสั่งซื้อของตนเอง) ตรวจสอบว่า `lineId` ของคำขอตรงกับ `lineId` ที่เชื่อมโยงกับคำสั่งซื้อนั้น

### 3.2 การตรวจสอบและกรองข้อมูลที่รับเข้ามา

*   **ปัญหา:** การตรวจสอบความถูกต้องของข้อมูลที่รับเข้ามาฝั่งไคลเอ็นต์สามารถถูกข้ามได้ ข้อมูลที่ไม่ผ่านการกรองอาจนำไปสู่ปัญหาความสมบูรณ์ของข้อมูลหรือพฤติกรรมที่ไม่คาดคิด
*   **คำแนะนำ:** ใช้ **การตรวจสอบและกรองข้อมูลที่รับเข้ามาฝั่งเซิร์ฟเวอร์** ที่แข็งแกร่งสำหรับข้อมูลทั้งหมดที่ได้รับในคำขอ `doPost`
    *   **ตรวจสอบประเภทข้อมูล:** ตรวจสอบให้แน่ใจว่าฟิลด์ตัวเลขเป็นตัวเลขจริง (`d.baseCb`, `d.cb`, `d.bp`)
    *   **ตรวจสอบเนื้อหา:** สำหรับฟิลด์ข้อความ (`d.title`, `d.detail`, `d.category`) กำหนดขีดจำกัดความยาวและพิจารณาข้อจำกัดอักขระหากจำเป็น
    *   **กรอง HTML:** หากข้อความที่ผู้ใช้ให้มาสามารถแสดงผลเป็น HTML ในภายหลัง (เช่น ใน `index.html` สำหรับการแสดงผล) ตรวจสอบให้แน่ใจว่าได้รับการหลีกเลี่ยงหรือกรองอย่างถูกต้องเพื่อป้องกัน XSS โดยทั่วไป `HtmlService` ของ Apps Script จะจัดการการหลีกเลี่ยงหากส่งออกไปยัง HTML แต่การจัดการ DOM โดยตรงฝั่งไคลเอ็นต์ต้องใช้การกรองอย่างระมัดระวัง

### 3.3 การอ้างอิงอ็อบเจกต์ที่ปลอดภัย

*   **ปัญหา:** การกระทำเช่น `updateOrder`, `finishOrder`, `deleteRowItem` ใช้ค่า `id` โดยตรง หาก ID เหล่านี้คาดเดาได้ อาจนำไปสู่การเข้าถึงบันทึกอื่นโดยไม่ได้รับอนุญาต
*   **คำแนะนำ:**
    *   ตรวจสอบให้แน่ใจว่า ID บันทึกทั้งหมดไม่ซ้ำกันและคาดเดาได้ยาก (ปัจจุบัน `ORD-` + timestamp เป็นจุดเริ่มต้นที่เหมาะสม แต่สามารถปรับปรุงให้มีความสุ่มมากขึ้น)
    *   เมื่อการกระทำกำหนดเป้าหมายบันทึกเฉพาะโดย `id` **ต้อง** รวมการตรวจสอบ `id` เข้ากับการตรวจสอบการอนุญาตเพื่อให้แน่ใจว่าผู้ใช้ที่ร้องขอมีสิทธิ์ในการแก้ไข *บันทึกเฉพาะนั้น*

### 3.4 การลดการเปิดเผยข้อมูล

*   **ปัญหา:** `getTableData` ดึงข้อมูลทั้งหมดจากชีต และ `getDashboardData` เปิดเผยสถิติสมาชิกโดยละเอียด
*   **คำแนะนำ:** เมื่อดึงข้อมูล ตรวจสอบให้แน่ใจว่าข้อมูลที่จำเป็นขั้นต่ำสุดเท่านั้นที่ถูกส่งคืนไปยังไคลเอ็นต์
    *   สำหรับ `fetchOrders` (เมื่อผู้ใช้ทั่วไปดูคำสั่งซื้อของตน) `Code.gs` ควรกรองผลลัพธ์ด้วย `lineId` ฝั่งเซิร์ฟเวอร์ แทนที่จะส่งคำสั่งซื้อทั้งหมดไปยังไคลเอ็นต์เพื่อกรองฝั่งไคลเอ็นต์
    *   กรองข้อมูลที่ละเอียดอ่อนออก (เช่น รายละเอียด BP/CB บางอย่าง) จาก `getDashboardData` หรือ `getUserStats` หากผู้ใช้ไม่ใช่ 'Head Chef'

### 3.5 การจัดการข้อผิดพลาดแบบทั่วไป

*   **ปัญหา:** `Code.gs` ส่งคืน `err.toString()` ไปยังไคลเอ็นต์ ซึ่งอาจเปิดเผยรายละเอียดที่ละเอียดอ่อนฝั่งเซิร์ฟเวอร์
*   **คำแนะนำ:** ใน `jsonResponse` สำหรับกรณีข้อผิดพลาด ให้ส่งคืนข้อความข้อผิดพลาดที่เป็นมิตรต่อผู้ใช้แบบทั่วไปเท่านั้น บันทึกข้อผิดพลาดโดยละเอียดบนเซิร์ฟเวอร์โดยใช้ `Logger.log` สำหรับการดีบัก

## 4. ไฟล์และไดเรกทอรีที่สำคัญ

*   `index.html`: แอปพลิเคชันส่วนหน้าหลัก, การรวม LIFF, ตรรกะ UI
*   `Code.gs`: ตรรกะส่วนหลัง, การรวม Google Sheets, ปลายทาง API
*   `old file/`: มีเวอร์ชันสำรองของ `index.html` และ `Code.gs` โปรดอ้างอิงสิ่งเหล่านี้สำหรับบริบททางประวัติศาสตร์หากจำเป็น แต่ให้ความสำคัญกับ `index.html` และ `Code.gs` ปัจจุบันเสมอ

## 5. ขั้นตอนการทำงานของนักพัฒนา

*   **การ Deploy:** การเปลี่ยนแปลง `index.html` ถูก Deploy โดยการ Push ไปยัง GitHub Pages การเปลี่ยนแปลง `Code.gs` ต้อง Deploy Google Apps Script เป็นเว็บแอปใหม่
*   **การ Debug:**
    *   **ส่วนหน้า:** ใช้เครื่องมือสำหรับนักพัฒนาเว็บของเบราว์เซอร์
    *   **ส่วนหลัง:** ใช้ `Logger.log()` ของ Apps Script editor และแท็บ "Executions" เพื่อดูบันทึกฝั่งเซิร์ฟเวอร์และดีบักการดำเนินการสคริปต์
